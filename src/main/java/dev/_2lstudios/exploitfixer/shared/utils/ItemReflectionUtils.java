package dev._2lstudios.exploitfixer.shared.utils;

import com.google.gson.Gson;
import com.mojang.authlib.GameProfile;
import com.mojang.authlib.properties.Property;

import org.bukkit.inventory.meta.SkullMeta;

import java.util.ArrayList;
import java.util.Base64;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class ItemReflectionUtils {
    private static final Gson GSON = new Gson();

    // TODO(Rayzr522): i'm not sure what the actual intended pattern is here, it doesn't appear to be a UUID v4 so i'm being a little loose here
    private static final Pattern SAFE_SKIN_URL = Pattern.compile("^https?://textures.minecraft.net/texture/[a-f0-9]{1,100}$");

    private static Function<Map<?, ?>, Map<?, ?>> getNestedMap(String key) {
        return map -> (Map<?, ?>) map.get(key);
    }

    private static Function<Map<?, ?>, Object> getMapValue(String key) {
        return map -> map.get(key);
    }

    private static Map<?, ?> parseJson(String input) {
        return GSON.fromJson(input, Map.class);
    }

    public static Optional<GameProfile> getGameProfile(SkullMeta meta) {
        return Optional.ofNullable(meta)
                .map(Reflector::getGameProfile);
    }

    public static Optional<String> getSkullTexture(GameProfile gameProfile) {
        return Optional.ofNullable(gameProfile)
                .map(GameProfile::getProperties)
                .map(properties -> properties.get("textures"))
                .map(ArrayList::new)
                .filter(textures -> textures.size() > 0)
                .map(textures -> textures.get(0))
                .map(Property::getValue);
    }

    public static Optional<String> getDecodedSkullTexture(String encodedSkullTexture) {
        return Optional.ofNullable(encodedSkullTexture)
                .map(Base64.getDecoder()::decode)
                .map(String::new);
    }

    public static Optional<String> getSkullTextureURL(String decodedJson) {
        return Optional.ofNullable(decodedJson)
                .map(ItemReflectionUtils::parseJson)
                .map(getNestedMap("textures"))
                .map(getNestedMap("SKIN"))
                .map(getMapValue("url"))
                .map(Objects::toString);
    }

    public static Optional<Boolean> isSafeSkullURL(String url) {
        return Optional.ofNullable(url)
                .map(SAFE_SKIN_URL::matcher)
                .map(Matcher::matches);
    }

    public static boolean isGameProfileSafe(GameProfile profile) {
        return Optional.ofNullable(profile)
                .flatMap(ItemReflectionUtils::getSkullTexture)
                .flatMap(ItemReflectionUtils::getDecodedSkullTexture)
                .flatMap(ItemReflectionUtils::getSkullTextureURL)
                .flatMap(ItemReflectionUtils::isSafeSkullURL)
                // TODO(Rayzr522): this could result from a failure to fetch game profile. do we really want to count that as an invalid skull URL?
                .orElse(false);
    }
}